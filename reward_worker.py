import base64
import mysql.connector as mysql
import datetime
import pandas as pd
import time

import json
from web3 import Web3 # https://web3py.readthedocs.io/en/stable/contracts.html#contract-functions

#######
## INIT
#######

# load api key
secret = {}
with open('secret.txt') as f:
    lines = f.readlines()
    for line in lines:
        secret[line.split("=")[0]] = line.split("=")[1].replace("\n","")

# init web3
infura_url = secret['INFURAURL1']
web3 = Web3(Web3.HTTPProvider(infura_url))
print(f"Connected to infura: {infura_url}")

# load abiÂ§ 
with open('abi.json') as f:
    abi = json.load(f)
# load bytecode
bytecode = '0x608060405234801561001057600080fd5b50600436106101f05760003560e01c8063cb6d13ec1161010f578063eb6045c0116100a2578063f2fde38b11610071578063f2fde38b14610dba578063f9244dd714610dfe578063f9f411d814610e42578063ff7a19bc14610ed0576101f0565b8063eb6045c014610b86578063f15559da14610c05578063f190b02b14610c93578063f222639814610d21576101f0565b8063db84e76f116100de578063db84e76f146109e4578063dd0408ae14610a28578063e5a11cf514610a56578063e7b9a3ca14610ac4576101f0565b8063cb6d13ec146108b8578063d348cbb914610930578063d61c0e781461097e578063d6b0f484146109da576101f0565b80638da5cb5b11610187578063b570e82e11610156578063b570e82e1461068b578063b585f9721461074d578063c0b11879146107d3578063c23ddcc514610855576101f0565b80638da5cb5b146104575780639bcfee2c146104a1578063a8b8551f1461050f578063b08328b414610584576101f0565b806351fb012d116101c357806351fb012d14610369578063715018a61461038b578063780aac0314610395578063837e811f146103f1576101f0565b806309a31218146101f55780632d1d70de1461026d5780633af32abf146102c957806350910ad614610325575b600080fd5b6102576004803603604081101561020b57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610eee565b6040518082815260200191505060405180910390f35b6102af6004803603602081101561028357600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610f13565b604051808215151515815260200191505060405180910390f35b61030b600480360360208110156102df57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610f70565b604051808215151515815260200191505060405180910390f35b6103676004803603602081101561033b57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610fcd565b005b610371611150565b604051808215151515815260200191505060405180910390f35b610393611163565b005b6103d7600480360360208110156103ab57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506112eb565b604051808215151515815260200191505060405180910390f35b61043d6004803603604081101561040757600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919050505061130b565b604051808215151515815260200191505060405180910390f35b61045f6113fd565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61050d600480360360408110156104b757600080fd5b8101908080357cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611426565b005b6105826004803603608081101561052557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919080356fffffffffffffffffffffffffffffffff191690602001909291908035906020019092919050505061172b565b005b6105d06004803603604081101561059a57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050611c26565b6040518089151515158152602001881515151581526020018773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001868152602001857cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191681526020018481526020018381526020018281526020019850505050505050505060405180910390f35b610737600480360360c08110156106a157600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080357cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19169060200190929190803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919080359060200190929190803515159060200190929190505050611ed2565b6040518082815260200191505060405180910390f35b6107b96004803603606081101561076357600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506123de565b604051808215151515815260200191505060405180910390f35b6107ff600480360360208110156107e957600080fd5b8101908080359060200190929190505050612503565b60405180827cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200191505060405180910390f35b6108976004803603602081101561086b57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050612537565b60405180831515151581526020018281526020019250505060405180910390f35b61091a600480360360408110156108ce57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050612618565b6040518082815260200191505060405180910390f35b61097c6004803603604081101561094657600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919050505061269f565b005b6109c06004803603602081101561099457600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506129c3565b604051808215151515815260200191505060405180910390f35b6109e26129e3565b005b610a26600480360360208110156109fa57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050612ac8565b005b610a5460048036036020811015610a3e57600080fd5b8101908080359060200190929190505050612cb0565b005b610ac260048036036060811015610a6c57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050613136565b005b610b6560048036036060811015610ada57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919080359060200190640100000000811115610b2157600080fd5b820183602082011115610b3357600080fd5b80359060200191846020830284011164010000000083111715610b5557600080fd5b9091929391929390505050613898565b60405180831515151581526020018281526020019250505060405180910390f35b610bef60048036036060811015610b9c57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919080356fffffffffffffffffffffffffffffffff19169060200190929190505050613f79565b6040518082815260200191505060405180910390f35b610c5160048036036020811015610c1b57600080fd5b8101908080357cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916906020019092919050505061408b565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b610cdf60048036036020811015610ca957600080fd5b8101908080357cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690602001909291905050506140be565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b610d6360048036036020811015610d3757600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050614253565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b83811015610da6578082015181840152602081019050610d8b565b505050509050019250505060405180910390f35b610dfc60048036036020811015610dd057600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506142ea565b005b610e4060048036036020811015610e1457600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506144f7565b005b610e8e60048036036040811015610e5857600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291905050506146bb565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b610ed8614706565b6040518082815260200191505060405180910390f35b6004602052816000526040600020602052806000526040600020600091509150505481565b600060011515600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff161515149050919050565b600060011515600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff161515149050919050565b610fd561470c565b73ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614611096576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b6001600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908315150217905550611104600160035461471490919063ffffffff16565b6003819055508073ffffffffffffffffffffffffffffffffffffffff167fde1a143e4682a29a126fd23660c6e5ccf6154fe8fbfbed7f6c5824e801e87a8c60405160405180910390a250565b600060149054906101000a900460ff1681565b61116b61470c565b73ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161461122c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a360008060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550565b60026020528060005260406000206000915054906101000a900460ff1681565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415801561134a575060008214155b61139f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260238152602001806157666023913960400191505060405180910390fd5b81600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008481526020019081526020016000206000015414905092915050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b61142e61470c565b73ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146114ef576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff16600a6000847cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146115e7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260248152602001806158226024913960400191505060405180910390fd5b60098290806001815401808255809150506001900390600052602060002090600a91828204019190066003029091909190916101000a81548162ffffff021916908360e81c021790555080600a6000847cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508073ffffffffffffffffffffffffffffffffffffffff16827cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167f906db1dc264299115396c15baaf3feb300d1496bbb5f8f689694257b62c482fb60405160405180910390a35050565b611735848461130b565b6117a7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f4552525f5f43414d504149474e5f444f45535f4e4f545f45584953545f36000081525060200191505060405180910390fd5b6117af61470c565b73ffffffffffffffffffffffffffffffffffffffff16600a6000600760008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600087815260200190815260200160002060050160009054906101000a900460e81b7cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614611905576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001806158966022913960400191505060405180910390fd5b60011515600760008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600085815260200190815260200160002060010160149054906101000a900460ff161515146119c2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001806158006022913960400191505060405180910390fd5b60001515600760008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600085815260200190815260200160002060010160159054906101000a900460ff16151514611a9c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260168152602001807f4552525f5f43414d504149474e5f49535f454e4445440000000000000000000081525060200191505060405180910390fd5b816fffffffffffffffffffffffffffffffff1916838573ffffffffffffffffffffffffffffffffffffffff167f1dac5b9aac710ec0ae08d431cb31d885e0e104b9e26512187e4200e1173ca84b600760008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008881526020019081526020016000206006016000876fffffffffffffffffffffffffffffffff19166fffffffffffffffffffffffffffffffff191681526020019081526020016000205485604051808381526020018281526020019250505060405180910390a480600760008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008581526020019081526020016000206006016000846fffffffffffffffffffffffffffffffff19166fffffffffffffffffffffffffffffffff191681526020019081526020016000208190555050505050565b600080600080600080600080611c3c8a8a61130b565b611cae576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f4552525f5f43414d504149474e5f444f45535f4e4f545f45584953545f33000081525060200191505060405180910390fd5b611cb66156bb565b600760008c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008b815260200190815260200160002060405180610160016040529081600082015481526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820160149054906101000a900460ff161515151581526020016001820160159054906101000a900460ff161515151581526020016002820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160038201548152602001600482015481526020016005820160009054906101000a900460e81b7cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191681526020016007820154815260200160088201548152602001600a8201548152505090508060400151816060015182608001518360c001518460e0015185610100015186610120015187610140015198509850985098509850985098509850509295985092959890939650565b600085611edd61470c565b73ffffffffffffffffffffffffffffffffffffffff16600a6000837cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614611ff0576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f4552525f5f43414d504149474e5f545950455f4b45595f4d49534d415443480081525060200191505060405180910390fd5b60008411612049576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001806158466026913960400191505060405180910390fd5b600085116120a2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260308152602001806157af6030913960400191505060405180910390fd5b60006120b7868661479c90919063ffffffff16565b90506120e68930838a73ffffffffffffffffffffffffffffffffffffffff16614822909392919063ffffffff16565b6120ef8961490f565b92506120f96156bb565b6040518061016001604052808581526020018b73ffffffffffffffffffffffffffffffffffffffff1681526020016000151587151514151581526020016000151581526020018973ffffffffffffffffffffffffffffffffffffffff1681526020018381526020018381526020018a7cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191681526020018781526020018881526020016000815250905080600760008c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008681526020019081526020016000206000820151816000015560208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060408201518160010160146101000a81548160ff02191690831515021790555060608201518160010160156101000a81548160ff02191690831515021790555060808201518160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060a0820151816003015560c0820151816004015560e08201518160050160006101000a81548162ffffff021916908360e81c02179055506101008201518160070155610120820151816008015561014082015181600a0155905050600860008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020849080600181540180825580915050600190039060005260206000200160009091909190915055838a73ffffffffffffffffffffffffffffffffffffffff167fa13cd4c5651563d3fab1b833a5797427514285b65fd0fa1ff9175c12f01681eb60405160405180910390a38393505050509695505050505050565b60006123ea848461130b565b61245c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f4552525f5f43414d504149474e5f444f45535f4e4f545f45584953545f31000081525060200191505060405180910390fd5b600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600084815260200190815260200160002060090160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1690509392505050565b6009818154811061251057fe5b90600052602060002090600a9182820401919006600302915054906101000a900460e81b81565b600080600061254d61254761470c565b85612618565b9050600081116125c5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260198152602001807f4552525f5f494e53554646494349454e545f42414c414e43450000000000000081525060200191505060405180910390fd5b6125f76125d061470c565b828673ffffffffffffffffffffffffffffffffffffffff166149bf9092919063ffffffff16565b61260961260261470c565b8583614a77565b50506001819250925050915091565b6000600460008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b6126a9828261130b565b61271b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f4552525f5f43414d504149474e5f444f45535f4e4f545f45584953545f34000081525060200191505060405180910390fd5b61272361470c565b73ffffffffffffffffffffffffffffffffffffffff16600a6000600760008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600085815260200190815260200160002060050160009054906101000a900460e81b7cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614612879576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001806158966022913960400191505060405180910390fd5b60011515600760008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600083815260200190815260200160002060010160149054906101000a900460ff16151514612953576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f4552525f5f43414d504149474e5f414c52454144595f5055424c49534845440081525060200191505060405180910390fd5b6000600760008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600083815260200190815260200160002060010160146101000a81548160ff0219169083151502179055505050565b60016020528060005260406000206000915054906101000a900460ff1681565b6129eb61470c565b73ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614612aac576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b60008060146101000a81548160ff021916908315150217905550565b612ad061470c565b73ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614612b91576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b60001515612b9e82610f70565b151514612c13576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4552525f5f414444524553535f414c52454144595f57484954454c495354454481525060200191505060405180910390fd5b60018060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508073ffffffffffffffffffffffffffffffffffffffff167f1dbccbca1ecf6973562a20da8f7a7885a167263c4a600dba185d45a6687fca5060405160405180910390a250565b612cba328261130b565b612d2c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f4552525f5f43414d504149474e5f444f45535f4e4f545f45584953545f35000081525060200191505060405180910390fd5b60001515600760003273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600083815260200190815260200160002060010160159054906101000a900460ff16151514612e06576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f4552525f5f43414d504149474e5f414c52454144595f454e444544000000000081525060200191505060405180910390fd5b6001600760003273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600083815260200190815260200160002060010160156101000a81548160ff0219169083151502179055506000600760003273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008381526020019081526020016000206004015411156130ef576000600760003273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600083815260200190815260200160002060020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690506000600760003273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600084815260200190815260200160002060040154111561309457613093600760003273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600084815260200190815260200160002060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600760003273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000858152602001908152602001600020600401548373ffffffffffffffffffffffffffffffffffffffff166149bf9092919063ffffffff16565b5b6000600760003273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600084815260200190815260200160002060040181905550505b803273ffffffffffffffffffffffffffffffffffffffff167f22a780e8b99af1145741fee0058110cfe4b815a8bca0d67fb3de62b2e0908fd360405160405180910390a350565b600115156002600061314661470c565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16151514613203576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f4552525f5f444154415f50524f56494445525f524f4c455f4d495353494e470081525060200191505060405180910390fd5b60001515600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600084815260200190815260200160002060010160149054906101000a900460ff161515146132dd576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f4552525f5f43414d504149474e5f49535f4e4f545f5055424c4953484544000081525060200191505060405180910390fd5b6001600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600084815260200190815260200160002060090160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555061345781600760008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600085815260200190815260200160002060020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600760008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600086815260200190815260200160002060080154615041565b50506134c06001600760008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000858152602001908152602001600020600a015461471490919063ffffffff16565b600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000848152602001908152602001600020600a0181905550600760008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600083815260200190815260200160002060080154600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008481526020019081526020016000206004015411613622576000600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600084815260200190815260200160002060040181905550613733565b6136db600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600084815260200190815260200160002060080154600760008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008581526020019081526020016000206004015461529190919063ffffffff16565b600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000848152602001908152602001600020600401819055505b8073ffffffffffffffffffffffffffffffffffffffff16828473ffffffffffffffffffffffffffffffffffffffff167feeecc2fca78e5b3eaac3c78bc0db4c19d0b8d600a75bbb4911c4a5e458a515ac600760008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600087815260200190815260200160002060020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600760008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600088815260200190815260200160002060080154604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390a4505050565b60008060011515600260006138ab61470c565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16151514613968576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f4552525f5f444154415f50524f56494445525f524f4c455f4d495353494e470081525060200191505060405180910390fd5b613972868661130b565b6139e4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f4552525f5f43414d504149474e5f444f45535f4e4f545f45584953545f32000081525060200191505060405180910390fd5b60001515600760008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600087815260200190815260200160002060010160149054906101000a900460ff16151514613abe576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f4552525f5f43414d504149474e5f49535f4e4f545f5055424c4953484544000081525060200191505060405180910390fd5b60001515600760008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600087815260200190815260200160002060010160159054906101000a900460ff16151514613b98576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f4552525f5f43414d504149474e5f454e4445445f42595f4d414e41474552000081525060200191505060405180910390fd5b600760008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600086815260200190815260200160002060070154600760008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000878152602001908152602001600020600a015410613cb3576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f4552525f5f4d4158494d554d5f434c41494d535f52454143484544000000000081525060200191505060405180910390fd5b6000600760008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008781526020019081526020016000206004015411613d7c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260198152602001807f4552525f5f4e4f5f52454d41494e494e475f42414c414e43450000000000000081525060200191505060405180910390fd5b60008090505b84849050811015613f685760001515600760008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008881526020019081526020016000206009016000878785818110613df257fe5b9050602002013573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615151415613f5b57600760008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600087815260200190815260200160002060070154600760008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000888152602001908152602001600020600a015410613f1157613f68565b613f448787878785818110613f2257fe5b9050602002013573ffffffffffffffffffffffffffffffffffffffff16613136565b613f5860018361471490919063ffffffff16565b91505b8080600101915050613d82565b506001819150915094509492505050565b6000613f85848461130b565b613ff7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f4552525f5f43414d504149474e5f444f45535f4e4f545f45584953545f37000081525060200191505060405180910390fd5b600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008481526020019081526020016000206006016000836fffffffffffffffffffffffffffffffff19166fffffffffffffffffffffffffffffffff191681526020019081526020016000205490509392505050565b600a6020528060005260406000206000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600081600073ffffffffffffffffffffffffffffffffffffffff16600a6000837cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156141d7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601a8152602001807f4552525f5f494e56414c49445f43414d504149474e5f5459504500000000000081525060200191505060405180910390fd5b600a6000847cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16915050919050565b6060600860008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208054806020026020016040519081016040528092919081815260200182805480156142de57602002820191906000526020600020905b8154815260200190600101908083116142ca575b50505050509050919050565b6142f261470c565b73ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146143b3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415614439576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001806157896026913960400191505060405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6144ff6113fd565b73ffffffffffffffffffffffffffffffffffffffff1661451d61470c565b73ffffffffffffffffffffffffffffffffffffffff16148061458f575060011515600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff161515145b614601576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260168152602001807f4552525f5f5045524d495353494f4e5f44454e4945440000000000000000000081525060200191505060405180910390fd5b6000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555061466f600160035461529190919063ffffffff16565b6003819055508073ffffffffffffffffffffffffffffffffffffffff167ff3892e221dcbf3c8153e5533a26396c0a7a5c518ba1b5c18396f4cbc7fd71dad60405160405180910390a250565b600560205281600052604060002081815481106146d457fe5b906000526020600020016000915091509054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60035481565b600033905090565b600080828401905083811015614792576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f536166654d6174683a206164646974696f6e206f766572666c6f77000000000081525060200191505060405180910390fd5b8091505092915050565b6000808314156147af576000905061481c565b60008284029050828482816147c057fe5b0414614817576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260218152602001806157df6021913960400191505060405180910390fd5b809150505b92915050565b614909846323b872dd60e01b858585604051602401808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019350505050604051602081830303815290604052907bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506152db565b50505050565b6000600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490506000811161496057600190505b61497460018261471490919063ffffffff16565b600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550809050919050565b614a728363a9059cbb60e01b8484604051602401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200182815260200192505050604051602081830303815290604052907bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506152db565b505050565b60008082600460008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205411614b84576000600460008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550614c94565b614c1383600460008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461529190919063ffffffff16565b600460008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055505b6000614ca08686612618565b1415614fb65760008090505b600560008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002080549050811015614fb4578473ffffffffffffffffffffffffffffffffffffffff16600560008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208281548110614d5757fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415614fa757600560008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001600560008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020805490500381548110614e2d57fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600560008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208281548110614ea257fe5b9060005260206000200160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600560008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001600560008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020805490500381548110614f7957fe5b9060005260206000200160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690555b8080600101915050614cac565b505b6001600460008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205491509150935093915050565b60008060006150508686612618565b14156150f757600560008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020849080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b61518683600460008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461471490919063ffffffff16565b600460008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506001600460008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205491509150935093915050565b60006152d383836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f7700008152506153ca565b905092915050565b606061533d826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c65648152508573ffffffffffffffffffffffffffffffffffffffff1661548a9092919063ffffffff16565b90506000815111156153c55780806020019051602081101561535e57600080fd5b81019080805190602001909291905050506153c4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602a81526020018061586c602a913960400191505060405180910390fd5b5b505050565b6000838311158290615477576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825283818151815260200191508051906020019080838360005b8381101561543c578082015181840152602081019050615421565b50505050905090810190601f1680156154695780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b5060008385039050809150509392505050565b606061549984846000856154a2565b90509392505050565b60606154ad856156a8565b61551f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601d8152602001807f416464726573733a2063616c6c20746f206e6f6e2d636f6e747261637400000081525060200191505060405180910390fd5b600060608673ffffffffffffffffffffffffffffffffffffffff1685876040518082805190602001908083835b6020831061556f578051825260208201915060208101905060208303925061554c565b6001836020036101000a03801982511681845116808217855250505050505090500191505060006040518083038185875af1925050503d80600081146155d1576040519150601f19603f3d011682016040523d82523d6000602084013e6155d6565b606091505b509150915081156155eb5780925050506156a0565b6000815111156155fe5780518082602001fd5b836040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825283818151815260200191508051906020019080838360005b8381101561566557808201518184015260208101905061564a565b50505050905090810190601f1680156156925780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b949350505050565b600080823b905060008111915050919050565b60405180610160016040528060008152602001600073ffffffffffffffffffffffffffffffffffffffff168152602001600015158152602001600015158152602001600073ffffffffffffffffffffffffffffffffffffffff168152602001600081526020016000815260200160007cffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19168152602001600081526020016000815260200160008152509056fe4552525f5f494e56414c49445f4d414e414745525f4f525f43414d504149474e5f49444f776e61626c653a206e6577206f776e657220697320746865207a65726f20616464726573734552525f5f414d4f554e545f5045525f434c41494d5f4d5553545f42455f47524541544845525f5448414e5f5a45524f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f774552525f5f43414d504149474e5f49535f414c52454144595f5055424c49534845444552525f5f43414d504149474e5f545950455f4b45595f414c52454144595f54414b454e4552525f5f434c41494d535f4d5553545f42455f47524541544845525f5448414e5f5a45524f5361666545524332303a204552433230206f7065726174696f6e20646964206e6f7420737563636565644552525f5f494e56414c49445f43414d504149474e5f545950455f41444452455353a26469706673582212208b6b118b329e6f65b3c952ccbb394c7b6c9aec2cc7c4c10ac8542a2c53503a9464736f6c63430006020033'

contract_address = '0xAA06763fe9cfDF52394990b7A3e4C26D32D113dC'


###############################
### ROUND UP TO NEXT K MINUTES
###############################
def round_time(dt=None, date_delta=datetime.timedelta(minutes=1), to='average'):
    """
    Round a datetime object to a multiple of a timedelta
    dt : datetime.datetime object, default now.
    dateDelta : timedelta object, we round to a multiple of this, default 1 minute.
    from:  http://stackoverflow.com/questions/3463930/how-to-round-the-minute-of-a-datetime-object-python
    """
    round_to = date_delta.total_seconds()
    if dt is None:
        dt = datetime.now()
    seconds = (dt - dt.min).seconds

    if seconds % round_to == 0 and dt.microsecond == 0:
        rounding = (seconds + round_to / 2) // round_to * round_to
    else:
        if to == 'up':
            # // is a floor division, not a comment on following line (like in javascript):
            rounding = (seconds + dt.microsecond/1000000 + round_to) // round_to * round_to
        elif to == 'down':
            rounding = seconds // round_to * round_to
        else:
            rounding = (seconds + round_to / 2) // round_to * round_to

    return dt + datetime.timedelta(0, rounding - seconds, - dt.microsecond)

# next run is now
nextrun15seconds = datetime.datetime.now()
nextrun15minutes = round_time(datetime.datetime.now(), date_delta=datetime.timedelta(minutes=1), to='up')

while True:
    now = datetime.datetime.now()

    if now > nextrun15seconds:
        print(f"XXX, {now}, {nextrun15seconds}")

        try:

            ##########################
            ### WRITE TO REWARDS TABLE
            ##########################
            print(now, 'do 15s stuff')

            ###########################
            ## GET USER:WALLET MAPPINGS
            ###########################

            # convert rewards pending twitter handles to wallet ids
            db = mysql.connect(host=secret['DBHOST'],user=secret['DBUSER'],passwd=secret['DBPASS'],database=secret['DBTABLE'])
            cursor = db.cursor()
            query = f'SELECT twitter_handle, ethereum_address FROM users;'
            cursor.execute(query)
            records = cursor.fetchall()
            cursor.close()
            db.close()
            # convert to dataframe
            users = []
            for record in records:
                users.append(dict(zip(['twitter_handle', 'ethereum_address'], record)))
            # convert to dataframe and lowercase handle
            users = pd.DataFrame(users)
            users['twitter_handle'] = users['twitter_handle'].str.lower()

            # create dicts
            user_wallets = dict(zip(list(users['twitter_handle']), users['ethereum_address']))
            wallets_users = dict(zip(list(users['ethereum_address']), users['twitter_handle']))

            # create list
            user_list = list(user_wallets.keys())

            #######################
            ## GET ACTIVE CAMPAIGNS
            #######################

            # get all campaigns with twitter handle so we can get twitter link
            db = mysql.connect(host=secret['DBHOST'],user=secret['DBUSER'],passwd=secret['DBPASS'],database=secret['DBTABLE'])
            cursor = db.cursor()
            query = f'SELECT campaign_id, manager_ethereum_address, maximum_rewards, campaign_type, twitter_status_id  FROM unite_db.campaigns;'
            cursor.execute(query)
            records = cursor.fetchall()
            print(f"{len(records)} campaigns found")
            cursor.close()
            db.close()

            columns = ['campaign_id', 'manager_ethereum_address', 'maximum_rewards', 'campaign_type', 'twitter_status_id']

            campaigns = []
            for record in records:
                res = dict(zip(columns, record))

                # check how many rewards claimed for this campaign
                db = mysql.connect(host=secret['DBHOST'], user=secret['DBUSER'], passwd=secret['DBPASS'], database=secret['DBTABLE'])
                cursor = db.cursor()
                campaign_id = res['campaign_id']
                manager_ethereum_address = res['manager_ethereum_address']
                query = f'SELECT * FROM unite_db.rewards where campaign_id = "{campaign_id}" and manager_ethereum_address = {manager_ethereum_address};'
                cursor.execute(query)
                records_rewards = cursor.fetchall()
                print(f"campaign #{res['campaign_id']} has {len(records_rewards)} rewards claimed, {res['maximum_rewards'] - len(records_rewards)} remaining")
                cursor.close()
                db.close()

                # calculate rewards remaining
                res['rewards_remaining'] = res['maximum_rewards'] - len(records_rewards)

                # only keep active campaigns
                if res['rewards_remaining'] > 0:
                    campaigns.append(res)

            print(f"{len(campaigns)} active campaigns found")

            #################################################
            ### WRITE TO REWARDS TABLE BASED ON TWITTER TABLE
            #################################################

            for campaign in campaigns:
                print(f"Begin rewards process for campaign {campaign_id}")

                ###########################
                ### GET TWEETS FOR CAMPAIGN
                ###########################

                # get tweets for this campaign
                db = mysql.connect(host=secret['DBHOST'],user=secret['DBUSER'],passwd=secret['DBPASS'],database=secret['DBTABLE'])
                cursor = db.cursor()
                query = f'SELECT id, tweet_id, referenced_tweet_id, twitter_handle, author_id, created_at, following, following_processed FROM unite_db.twitter where referenced_tweet_id = {campaign["twitter_status_id"]};'
                cursor.execute(query)
                records_tweets = cursor.fetchall()
                cursor.close()
                db.close()
                #
                tweets = []
                for record in records_tweets:
                    tweets.append(dict(zip(['id', 'tweet_id', 'referenced_tweet_id', 'twitter_handle', 'author_id', 'created_at', 'following', 'following_processed'], record)))
                tweets = pd.DataFrame(tweets)


                ##########################
                ### WORK OUT WHO TO REWARD
                ##########################

                # get all rewards for this campaign as dataframe
                db = mysql.connect(host=secret['DBHOST'],user=secret['DBUSER'],passwd=secret['DBPASS'],database=secret['DBTABLE'])
                cursor = db.cursor()
                campaign_id = campaign['campaign_id']
                query = f'SELECT id, campaign_id, twitter_handle, blockchain_write_time FROM unite_db.rewards where campaign_id = {campaign_id} and manager_ethereum_address = {manager_ethereum_address};'
                cursor.execute(query)
                records_rewards = cursor.fetchall()
                cursor.close()
                db.close()
                # convert to dataframe
                rewards = []
                for record in records_rewards:
                    rewards.append(dict(zip(['id', 'campaign_id', 'twitter_handle', 'blockchain_write_time'], record)))
                df = pd.DataFrame(rewards)

                # get list of handles already rewarded for this campaign
                handles = []
                if len(tweets) > 0:
                    handles = list(tweets['twitter_handle'].unique())
                    handles = [h.lower() for h in handles]

                # going to decrement rewards remaining as they're assigned
                rewards_remaining = campaign['rewards_remaining']

                # loop over handles and check who to reward
                for i, handle in enumerate(handles):
                    print(f"{i+1} / {len(handles)} checking if {handle} already rewarded")

                    # user must be "registered"
                    if handle in user_list:
                        # campaign must have rewards left
                        if rewards_remaining > 0: 
                            if 'twitter_handle' in list(df.columns) and handle in handles:
                                print(f"  # {handle} already rewarded")
                            else:
                                print(f"  # {handle} needs rewards")
                                # write rewards to database (with null blockchainwritetime)
                                db = mysql.connect(host=secret['DBHOST'],user=secret['DBUSER'],passwd=secret['DBPASS'],database=secret['DBTABLE'])
                                cursor = db.cursor()
                                query = "INSERT INTO rewards (campaign_id, twitter_handle, manager_ethereum_address) VALUES (%s, %s, %s);"
                                values = (campaign['campaign_id'], handle, campaign['manager_ethereum_address'])
                                cursor.execute(query, values)
                                db.commit()
                                print(cursor.rowcount, "record inserted")
                                cursor.close()
                                db.close()  

                                rewards_remaining -= 1
                        else:
                            print("Rewards exceeded for campaign")
                            break
                    else:
                        print(f"  # User {handle} not registered")


            # update next run to 15 seconds from now
            nextrun15seconds = now + datetime.timedelta(seconds=15)

            print(f'{now} NEXT 15sec RUN: {nextrun15seconds}')

        except Exception as e:
            print("ERROR")
            print(e)
    else:
        print(f"{now} sleeping 15 seconds")
        time.sleep(15)
